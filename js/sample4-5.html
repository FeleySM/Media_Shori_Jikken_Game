<!-- オブジェクトのグループ化 -->
<!doctype html>
<html>
<head>
<meta charset="UTF-8">
<title>Sample</title>
<script src="js/three.js"></script>
<script src="js/OrbitControls.js"></script>

<script>
	document.addEventListener('DOMContentLoaded', exec); // body が読み込み終わるまで待つ

	var width = 960;
	var height = 600;
	var side = 10;
	var border = 100;
	var scene ;
	var camera;
	var mesh; 
	var renderer;
	var light;
	var isMouseclick = false;
	var shifty = 0;
	var snowman;
	var snow;
	let isSpacePushed = false;
	function exec(){
		// Mouseイベント
		document.addEventListener("click", function(e) {
			if ( isMouseclick ==   false ) isMouseclick = true;
		});

		// シーンを作る
		scene = new THREE.Scene();
		// ライトの設定
		light = new THREE.DirectionalLight(0xffffff, 1.0);
		//light = new THREE.PointLight(0xFFFFFF, 2, 100, 1.0);
		light.position.set(-1, 1, 1); // ライトの向きを変更
		scene.add(light);
		var amb_light = new THREE.AmbientLight(0xFFFFFF, 0.5);
		scene.add(amb_light);
		// 雪だるまを作る関数を呼ぶ
		createSnowman();
		createSphere();
		createTree();
		createSnow();
		snowman.position.y = -border/2;

		// 床面
		var geometry1 = new THREE.BoxGeometry(border, 0.1, border); 
		var material1 = new THREE.MeshPhongMaterial({color: 0x77CC77});
		var mesh1 = new THREE.Mesh(geometry1, material1);
		mesh1.position.set(0, -border/2, 0);
		// シーンにオブジェクトを追加
		scene.add(mesh1);

		// カメラを設定
		camera = new THREE.PerspectiveCamera(90, width/height, 1, 1000); 
		camera.position.set(0, 0, 200);
		camera.lookAt(scene.position);
	
		//レンダラを作成
		renderer = new THREE.WebGLRenderer({canvas: document.getElementById('canvas1')});
		renderer.setSize(width, height);

		// カメラコントローラーを作成
		var controls = new THREE.OrbitControls(camera, renderer.domElement);

		update();
	}

	function  update() {
		if(isMouseclick == true ) {   // マウスのクリックによって雪だるまがジャンプ
			shifty += 2*Math.PI/60;
			snowman.position.y += 3*Math.pow(Math.sin(shifty), 3);
			if(shifty > 2*Math.PI) {
				shifty = 0;
				isMouseclick = false;
			}
		}

		renderer.render(scene, camera);　// レンダラーに描画することを命令する
		requestAnimationFrame(update);
	}

	// 雪だるまを作る関数
	function createSnowman(){
		// パーツをグループに登録するためのグループ（入れ物）を定義
		snowman = new THREE.Group();

		var sphere1 = new THREE.SphereGeometry( 10, 10, 10 );
		var sphere2 = new THREE.SphereGeometry( 8, 10, 10 );
		var material = new THREE.MeshPhongMaterial({color: 0xFFFFFF});

		var body = new THREE.Mesh(sphere1, material);
		var head = new THREE.Mesh(sphere2, material);
		body.position.y += 10;
		head.position.y += 26;
		var cylinder = new THREE.CylinderGeometry( 1, 5, 8, 10 );
		var material2 = new THREE.MeshPhongMaterial({color: 0xFF3333});
		var hat = new THREE.Mesh(cylinder, material2);
		hat.rotation.z = -Math.PI/6;
	    hat.position.y += 34;
	    hat.position.x += 4;

		snowman.add( body );
		snowman.add( head );
		snowman.add( hat );
		scene.add( snowman );
	}

	function createSphere(){
		const sphere = new THREE.SphereGeometry( 100, 100, 50 );
		const material = new THREE.MeshPhongMaterial({
			color: 0xFFFFFF,
			opacity: 0.3,
			transparent: true,
		  });
		const mesh = new THREE.Mesh(sphere, material);
		mesh.position.set(0, 10, 0);
		scene.add(mesh)
	}

	function createTree(){
		const tree = new THREE.Group()
		const level1 = new THREE.Mesh(
			new THREE.ConeGeometry(15, 20, 8),
			new THREE.MeshPhongMaterial({color: 0x00ff00})
		)
		level1.position.y = 60;
		tree.add(level1)

		const level2 = new THREE.Mesh(
			new THREE.ConeGeometry(20, 20, 8),
			new THREE.MeshPhongMaterial({color: 0x00ff00})
		)
		level2.position.y = 45;
		tree.add(level2)

		const level3 = new THREE.Mesh(
			new THREE.ConeGeometry(30, 20, 8),
			new THREE.MeshPhongMaterial({color: 0x00ff00})
		)
		level3.position.y = 30;
		tree.add(level3)

		const body = new THREE.Mesh(
			new THREE.CylinderGeometry(5, 5, 20),
			new THREE.MeshPhongMaterial({color: 0x734325})
		)
		body.position.y = 10;
		tree.add(body)
		scene.add(tree)
		tree.position.x = border - border/2 - 5;
		tree.position.y = -border/2 + 2;
		
	}

	function createSnow(){
		snow = new THREE.Group()
		var geometry = new THREE.BoxGeometry(0.5, 0.5, 0.5); 
		var material = new THREE.MeshLambertMaterial({color: 0xFFFFFF });
		for(var i=0; i<1000; i++) {
			var cube = new THREE.Mesh(geometry, material);
			cube.position.x = (Math.random() - 0.5)*120;
			cube.position.y = (Math.random() - 0.4)*border;
			cube.position.z = (Math.random() -0.5)*120;
			cube.rotation.x = Math.random() * 2 * Math.PI;
			cube.rotation.y = Math.random() * 2 * Math.PI;
			cube.rotation.z = Math.random() * 2 * Math.PI;
			// シーンにオブジェクトを追加
			snow.add(cube)
		}
		scene.add(snow)
	}
</script>

</head>

<body>
<h1>第6回メディア処理実験</h1>

<canvas id="canvas1" style="width: 960; height: 600;"></canvas>
<p>木をモデリングしてシーンに追加し、小さい白い四角形を使って雪を書きました。</p>
</body>
</html>
